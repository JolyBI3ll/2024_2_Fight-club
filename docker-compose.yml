services:
    certs:
        image: alpine:latest
        volumes:
            - .:/app
        entrypoint: "sh /app/ssl/generate-certs.sh"

    # Go migrator. It applies all needed migrations.
    migrator:
        image: golang:1.23.1
        working_dir: /app
        volumes:
            - .:/app
        command: sh -c "go run ./cmd/migrator"
        environment:
            - DB_HOST=${DB_HOST}
            - DB_PORT=${DB_PORT}
            - DB_USER=${DB_USER}
            - DB_PASSWORD=${DB_PASS}
            - DB_NAME=${DB_NAME}
        depends_on:
            - postgres
        networks:
            - app-network

    # Go backend
    backend:
        image: golang:1.23.1
        working_dir: /app
        ports:
            - "8008:8008"
        volumes:
            - .:/app
        command: go run ./cmd/webapp
        environment:
            - DB_HOST=${DB_HOST}
            - DB_PORT=${DB_PORT}
            - DB_USER=${DB_USER}
            - DB_PASSWORD=${DB_PASS}
            - DB_NAME=${DB_NAME}
            - MINIO_HOST=minio
            - MINIO_PORT=${MINIO_PORT}
            - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY}
            - MINIO_SECRET_KEY=${MINIO_SECRET_KEY}
            - REDIS_HOST=redis
            - REDIS_PORT=6379
        depends_on:
            - postgres
            - minio
            - certs
            - redis
        networks:
            - app-network

    # PostgreSQL database
    postgres:
        image: postgres:17
        ports:
            - "8077:5432"
        environment:
            POSTGRES_USER: ${DB_USER}
            POSTGRES_PASSWORD: ${DB_PASS}
            POSTGRES_DB: ${DB_NAME}
        volumes:
            - postgres_data:/var/lib/postgresql/data
        networks:
            - app-network

    # Redis for caching
    redis:
        image: redis:7
        ports:
            - "6379:6379"
        networks:
            - app-network

    # MinIO for object storage
    minio:
        image: minio/minio
        ports:
            - "9000:9000"
            - "8070:9001"
        environment:
            MINIO_ROOT_USER: ${MINIO_ROOT_USER}
            MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
        command: server /data --console-address ":9001"
        volumes:
            - minio_data:/data
        networks:
            - app-network

    # MinIO Client for bucket creation
    minio-client:
        image: minio/mc
        depends_on:
            - minio
        entrypoint: >
            /bin/sh -c "
            sleep 5;
            /usr/bin/mc alias set myminio http://minio:9000 ${MINIO_ROOT_USER} ${MINIO_ROOT_PASSWORD};
            /usr/bin/mc mb --ignore-existing myminio/images;
            /usr/bin/mc anonymous set download myminio/images;
            /usr/bin/mc anonymous set download myminio/cities;
            "
        networks:
            - app-network

    # Ads service
    ads_service:
        image: golang:1.23.1
        working_dir: /app
        ports:
            - "50052:50052"
        volumes:
            - .:/app
        command: go run ./microservices/ads_service/cmd/main.go
        depends_on:
            - redis
            - postgres
        environment:
            - DB_HOST=${DB_HOST}
            - DB_PORT=${DB_PORT}
            - DB_USER=${DB_USER}
            - DB_PASSWORD=${DB_PASS}
            - DB_NAME=${DB_NAME}
            - REDIS_HOST=redis
            - REDIS_PORT=6379
        networks:
            - app-network

    # Auth service
    auth_service:
        image: golang:1.23.1
        working_dir: /app
        ports:
            - "50051:50051"
        volumes:
            - .:/app
        command: go run ./microservices/auth_service/cmd/main.go
        depends_on:
            - redis
            - postgres
        environment:
            - DB_HOST=${DB_HOST}
            - DB_PORT=${DB_PORT}
            - DB_USER=${DB_USER}
            - DB_PASSWORD=${DB_PASS}
            - DB_NAME=${DB_NAME}
            - REDIS_HOST=redis
            - REDIS_PORT=6379
        networks:
            - app-network

    # City service
    city_service:
        image: golang:1.23.1
        working_dir: /app
        ports:
            - "50053:50053"
        volumes:
            - .:/app
        command: go run ./microservices/city_service/cmd/main.go
        depends_on:
            - redis
            - postgres
        environment:
            - DB_HOST=${DB_HOST}
            - DB_PORT=${DB_PORT}
            - DB_USER=${DB_USER}
            - DB_PASSWORD=${DB_PASS}
            - DB_NAME=${DB_NAME}
            - REDIS_HOST=redis
            - REDIS_PORT=6379
        networks:
            - app-network

volumes:
    postgres_data:
    minio_data:

networks:
    app-network:
        driver: bridge
